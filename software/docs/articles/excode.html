<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Excess count detection for epidemiological time series • excode</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Excess count detection for epidemiological time series">
<meta property="og:description" content="excode">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">excode</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/excode.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="excode_files/kePrint-0.0.1/kePrint.js"></script><link href="excode_files/lightable-0.0.1/lightable.css" rel="stylesheet">
<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Excess count detection for epidemiological time
series</h1>
                        <h4 data-toc-skip class="author">Benedikt
Zacher</h4>
            
            <h4 data-toc-skip class="date">2025-05-26</h4>
      
      
      <div class="hidden name"><code>excode.Rmd</code></div>

    </div>

    
    
<p><strong>Ex</strong>cess <strong>c</strong>ount
<strong>de</strong>tection (<em>excode</em>) in epidemiological time
series is an important part of public health surveillance systems. A
variety of algorithms has been developed to identify events such as
disease outbreaks or excess mortality. To this end, time series are
analysed to detect unusually large (case) counts, that exceed what is
normally expected in a certain time period and geographical region. The
normal expectancy of cases in a current time period is usually
calculated based on historic data. Depending on the time series of
interest, the following features need to be taken into account by a
model:</p>
<ul>
<li>
<strong>Seasonal patterns:</strong> Many epidemiological times
series that are of public health interest show periodic changes in cases
depending on seasons or other calendar periods.</li>
<li>
<strong>Long-term time trends:</strong> The time series may show a
long-term increase or decrease in case counts.</li>
<li>
<strong>Historic events:</strong> Events such as disease outbreaks
may have caused an excess of case counts in historic data that is used
for model estimation. This needs to be considered to avoid
overestimation of the normal expectancy for the current time
period.</li>
</ul>
<p>The <em>excode</em> package provides a flexible framework that
implements well established approaches to control for seasonality,
long-term trends and historic events, but also allows the use of
customized models. The user can choose between the Poisson and the
Negative Binomial distribution, which are the most commonly used
probability distributions for modeling count data. By combining hidden
Markov models and generalized linear models, <em>excode</em> explicitly
models normally expected case counts <em>and</em> expected excess case
counts, i.e. each time point in a time series is labeled either as a
normal state or as an excess state. A short overview of the statistical
model used can be found at the end of this document.</p>
<div class="section level2">
<h2 id="overwiew-of-available-models-in-excode">Overwiew of available models in <em>excode</em><a class="anchor" aria-label="anchor" href="#overwiew-of-available-models-in-excode"></a>
</h2>
<p>There are five different model classes implemented in
<em>excode</em>:</p>
<ul>
<li>
<strong>Mean:</strong> This model does not account for seasonal or
cyclical patterns. The expectancy of normal and excess case counts is
modeled as the mean of the historic data.</li>
<li>
<strong>FarringtonNoufaily:</strong> This is a popular algorithm,
which models seasonality by segmenting a year into a predefined number
of shorter time periods, where each has a different expectancy of
observed cases. It also allows integration of a long-term time
trend.</li>
<li>
<strong>Harmonic:</strong> The ‘Harmonic’ model uses sine and cosine
function to account for seasonal or cyclical patterns in the data. It
also allows integration of long-term time trends.</li>
<li>
<strong>Custom:</strong> The ‘Custom’ model allows the user define
their own model by providing a data frame containing covariate
data.</li>
</ul>
<p>All of the above mentioned models use two states - a ‘normal’ and an
‘excess’ state - to detect excess counts. However in some cases it might
be necessary to allow multiple states, such as ‘normal’, ‘low excess’,
‘medium excess’, ‘high excess’, to account for a wide range of excess
counts and detect all periods showing an excess in a time series.</p>
<ul>
<li>
<strong>MultiState:</strong> The ‘MultiState’ model allows the use
of multiple states. The number of states can be specified by the user.
Like in the ‘Custom’ model, the user must provide covariate data to
control for possible seasonal or long-term time trends. The use of this
model is more advanced than the other models and requires some
additional steps before fitting.</li>
</ul>
<p>Figure 1 shows examples for the ‘Mean’, ‘Harmonic’ and
‘FarringtonNoufaily’ model.</p>
<div class="figure" style="text-align: center">
<img src="excode_files/figure-html/Example%20Mean%20model-1.png" alt="**Figure 1:** Examples for the 'Mean', 'Harmonic' and 'FarringtonNoufaily' model." width="576"><p class="caption">
<strong>Figure 1:</strong> Examples for the ‘Mean’, ‘Harmonic’ and
‘FarringtonNoufaily’ model.
</p>
</div>
</div>
<div class="section level2">
<h2 id="using-excode-for-excess-count-detection">Using <em>excode</em> for excess count detection<a class="anchor" aria-label="anchor" href="#using-excode-for-excess-count-detection"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">excode</span><span class="op">)</span></span></code></pre></div>
<p>The input data is a timeseries containing a date and an observed
number of cases. It can be a <code>data.frame</code>, an
<code>sts</code> object from the <a href="https://cran.r-project.org/web/packages/surveillance/index.html" class="external-link">surveillance
R package</a> or a list of sts objects.</p>
<p>The input dataset needs to contain the following variables:</p>
<ul>
<li>
<strong>date</strong>: The date of aggregation.<br>
</li>
<li>
<strong>observed</strong>: The observed number of cases.</li>
<li>
<strong>id</strong>: The name or id of the time series.</li>
</ul>
<p>Optional variables can be:</p>
<ul>
<li>
<strong>offset</strong> (optional): This could be e.g. the
susceptible population.</li>
<li>
<strong>state</strong> (optional): If there are events, such as
disease outbreaks, that caused excess counts or if there are time
periods that are known to have normal case counts, these can be
indicated here (e.g. 0=normal, 1=excess, NA=unknown).</li>
</ul>
<p>The example data <code>shadar_df</code> in this section contains the
number of weekly cases of <em>Salmonella hadar</em> from 2001 until 2006
in Germany (taken from the <a href="https://cran.r-project.org/web/packages/surveillance/index.html" class="external-link">surveillance
package</a>). This dataset does not contain an <strong>offset</strong>
and <strong>state</strong> variable as we do not adjust for population
size and the true disease outbreak labels are not included.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Load data an show first 6 rows</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"shadar_df"</span><span class="op">)</span></span>
<span><span class="fu">kable</span><span class="op">(</span><span class="fu">as_tibble</span><span class="op">(</span><span class="va">shadar_df</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">kable_styling</span><span class="op">(</span>font_size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span></span></code></pre></div>
<table class="table table" style="font-size: 11px; margin-left: auto; margin-right: auto;">
<thead><tr>
<th style="text-align:left;">
date
</th>
<th style="text-align:right;">
observed
</th>
<th style="text-align:left;">
id
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
2001-01-08
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
S. Hadar Germany
</td>
</tr>
<tr>
<td style="text-align:left;">
2001-01-15
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:left;">
S. Hadar Germany
</td>
</tr>
<tr>
<td style="text-align:left;">
2001-01-22
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
S. Hadar Germany
</td>
</tr>
<tr>
<td style="text-align:left;">
2001-01-29
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
S. Hadar Germany
</td>
</tr>
<tr>
<td style="text-align:left;">
2001-02-05
</td>
<td style="text-align:right;">
15
</td>
<td style="text-align:left;">
S. Hadar Germany
</td>
</tr>
<tr>
<td style="text-align:left;">
2001-02-12
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:left;">
S. Hadar Germany
</td>
</tr>
</tbody>
</table>
<p>Figure 2 shows that there is a cyclical pattern of case counts, with
more cases during the summer and fewer cases cases during the winter
There is also a decrease of reported cases over the years, except for
the year 2006, <a href="https://www.rki.de/DE/Content/Infekt/EpidBull/Archiv/2006/Ausgabenlinks/31_06.pdf?__blob=publicationFile" class="external-link">where
an outbreak lead to a surge in case numbers compared to previous
years</a>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot the time series</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">shadar_df</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">observed</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_col</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"grey"</span>, fill <span class="op">=</span> <span class="st">"lightgrey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"No. of cases"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Week of notification"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_date</span><span class="op">(</span>date_labels <span class="op">=</span> <span class="st">"%Y"</span>, date_breaks <span class="op">=</span> <span class="st">"year"</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="excode_files/figure-html/Loading%20salmNewport-1.png" alt="**Figure 2:** Weekly *Salmonella Newport* cases." width="576"><p class="caption">
<strong>Figure 2:</strong> Weekly <em>Salmonella Newport</em> cases.
</p>
</div>
<p>Before running the excess count detection, the user needs to decide
which probability distribution and which model should be used. This is
done using the <code>excodeFamily</code> and <code>excodeFormula</code>
objects of the <em>excode</em> package. Both are then combined into an
<code>excodeModel</code> object, which stores all necessary parameters
and specifications for model fitting. In this example, the ‘Poisson’
distribution and - due to the cyclical and long-term time trend - the
‘Harmonic’ model is chosen.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Use a 'Poisson' distribution in excodeFamily</span></span>
<span><span class="va">excode_family_pois</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/excodeFamily.html">excodeFamily</a></span><span class="op">(</span><span class="st">"Poisson"</span><span class="op">)</span></span>
<span><span class="co"># Define the 'Harmonic' model in excodeFormula</span></span>
<span><span class="va">excode_formula_har</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/excodeFormula.html">excodeFormula</a></span><span class="op">(</span><span class="st">"Harmonic"</span><span class="op">)</span></span>
<span><span class="co"># Combine both in the final excodeModel object</span></span>
<span><span class="va">excode_har_pois</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/excodeModel.html">excodeModel</a></span><span class="op">(</span></span>
<span>  <span class="va">excode_family_pois</span>,</span>
<span>  <span class="va">excode_formula_har</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Printing <code>excode_har_pois</code> gives some basic information
about the model specifcations and shows that the model is an inital
model, which stores results for 0 time points:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">excode_har_pois</span></span></code></pre></div>
<pre><code><span><span class="co">## Inital excodeModel</span></span>
<span><span class="co">##  excodeFamily: Poisson</span></span>
<span><span class="co">##  excodeFormula: Harmonic</span></span>
<span><span class="co">## No. of timepoints: 0</span></span></code></pre>
<p>The <code><a href="../reference/run_excode.html">run_excode()</a></code> function then performs the excess count
detection. This function accepts different data types for the
surveillance timeseries (sts, data.frame, list of sts objects). The
output is a fitted <code>excodeModel</code> object -
<code>result_shadar_har</code> - that stores results for 87 time
points.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run excode on time points 209-295</span></span>
<span><span class="va">result_shadar_har</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_excode.html">run_excode</a></span><span class="op">(</span></span>
<span>  <span class="va">shadar_df</span>,</span>
<span>  <span class="va">excode_har_pois</span>,</span>
<span>  <span class="fl">209</span><span class="op">:</span><span class="fl">295</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">result_shadar_har</span></span></code></pre></div>
<pre><code><span><span class="co">## Fitted excodeModel</span></span>
<span><span class="co">##  excodeFamily: Poisson</span></span>
<span><span class="co">##  excodeFormula: Harmonic</span></span>
<span><span class="co">## No. of timepoints: 87</span></span></code></pre>
<p>Results can be extracted using the <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>
function:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summary_shadar_har</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">result_shadar_har</span><span class="op">)</span></span>
<span><span class="fu">kable</span><span class="op">(</span><span class="fu">as_tibble</span><span class="op">(</span><span class="va">summary_shadar_har</span><span class="op">[</span><span class="fl">82</span><span class="op">:</span><span class="fl">87</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">kable_styling</span><span class="op">(</span>font_size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span></span></code></pre></div>
<table class="table table" style="font-size: 11px; margin-left: auto; margin-right: auto;">
<thead><tr>
<th style="text-align:right;">
posterior
</th>
<th style="text-align:right;">
pval
</th>
<th style="text-align:left;">
date
</th>
<th style="text-align:right;">
timepoint
</th>
<th style="text-align:right;">
observed
</th>
<th style="text-align:right;">
mu0
</th>
<th style="text-align:right;">
mu1
</th>
<th style="text-align:left;">
id
</th>
<th style="text-align:right;">
BIC
</th>
<th style="text-align:right;">
AIC
</th>
<th style="text-align:right;">
posterior_ub
</th>
<th style="text-align:right;">
pval_ub
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
0.993
</td>
<td style="text-align:right;">
0.002
</td>
<td style="text-align:left;">
2006-07-24
</td>
<td style="text-align:right;">
290
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
3.27
</td>
<td style="text-align:right;">
11.1
</td>
<td style="text-align:left;">
S. Hadar Germany
</td>
<td style="text-align:right;">
1095
</td>
<td style="text-align:right;">
1012
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
8
</td>
</tr>
<tr>
<td style="text-align:right;">
1.000
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:left;">
2006-07-31
</td>
<td style="text-align:right;">
291
</td>
<td style="text-align:right;">
16
</td>
<td style="text-align:right;">
3.32
</td>
<td style="text-align:right;">
11.5
</td>
<td style="text-align:left;">
S. Hadar Germany
</td>
<td style="text-align:right;">
1099
</td>
<td style="text-align:right;">
1016
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
8
</td>
</tr>
<tr>
<td style="text-align:right;">
1.000
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:left;">
2006-08-07
</td>
<td style="text-align:right;">
292
</td>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
3.39
</td>
<td style="text-align:right;">
12.1
</td>
<td style="text-align:left;">
S. Hadar Germany
</td>
<td style="text-align:right;">
1106
</td>
<td style="text-align:right;">
1023
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
8
</td>
</tr>
<tr>
<td style="text-align:right;">
0.929
</td>
<td style="text-align:right;">
0.019
</td>
<td style="text-align:left;">
2006-08-14
</td>
<td style="text-align:right;">
293
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
3.27
</td>
<td style="text-align:right;">
11.6
</td>
<td style="text-align:left;">
S. Hadar Germany
</td>
<td style="text-align:right;">
1107
</td>
<td style="text-align:right;">
1024
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
8
</td>
</tr>
<tr>
<td style="text-align:right;">
1.000
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:left;">
2006-08-21
</td>
<td style="text-align:right;">
294
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
2.63
</td>
<td style="text-align:right;">
12.7
</td>
<td style="text-align:left;">
S. Hadar Germany
</td>
<td style="text-align:right;">
1103
</td>
<td style="text-align:right;">
1020
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
7
</td>
</tr>
<tr>
<td style="text-align:right;">
0.691
</td>
<td style="text-align:right;">
0.049
</td>
<td style="text-align:left;">
2006-08-28
</td>
<td style="text-align:right;">
295
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
2.60
</td>
<td style="text-align:right;">
11.8
</td>
<td style="text-align:left;">
S. Hadar Germany
</td>
<td style="text-align:right;">
1107
</td>
<td style="text-align:right;">
1023
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
7
</td>
</tr>
</tbody>
</table>
<p>The result is a <code>data.frame</code> with the following
variables:</p>
<ul>
<li>
<strong>posterior:</strong> Probability that there is an excess of
case counts at the current time point.</li>
<li>
<strong>pval:</strong> P-value for the null hypothesis that there is
no excess at the current timepoint.</li>
<li>
<strong>date:</strong> The event date (e.g. reporting date or date
of disease onset).</li>
<li>
<strong>timepoint:</strong> Timepoint (as integer) in the time
series.</li>
<li>
<strong>observed:</strong> Number of cases at the current time
point.</li>
<li>
<strong>mu0:</strong> Number of expected cases under normal
conditions.</li>
<li>
<strong>mu1:</strong> Number of expected cases under excess
conditions.</li>
<li>
<strong>id:</strong> Name of the time series.</li>
<li>
<strong>BIC:</strong> Bayesian information criterion.</li>
<li>
<strong>AIC:</strong> Aikake information criterion.</li>
<li>
<strong>posterior_ub:</strong> A count threshold based on the
Posterior probability of the model. If the observed counts exceed this
value, the time point is considered to have excess counts. The default
probability to calculate this threshold is 0.5 and can be changed via
the parameter <code>prob_threshold</code> in <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>.
.</li>
<li>
<strong>pval_ub:</strong> A count threshold based on the
background/normal model. If the observed counts exceed this value, the
time point is considered to have excess counts. The default p-value to
calculate this threshold is 0.01 and can be changed via the parameter
<code>pval_threshold</code> in <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>.</li>
</ul>
<p>Figure 3 shows the input data with the estimated alarm thresholds
(<em>posterior_ub</em> and <em>pval_ub</em>):</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span></span>
<span>  <span class="va">shadar_df</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/surveillance/man/sts-class.html" class="external-link">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">2003</span><span class="op">)</span>,</span>
<span>  <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">observed</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_col</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"grey"</span>, fill <span class="op">=</span> <span class="st">"lightgrey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"No. of cases"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Week of notification"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_date</span><span class="op">(</span>date_labels <span class="op">=</span> <span class="st">"%Y"</span>, date_breaks <span class="op">=</span> <span class="st">"year"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_step</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">posterior_ub</span>, color <span class="op">=</span> <span class="st">"upper bound (posterior)"</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">summary_shadar_har</span>, linewidth <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_step</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">pval_ub</span>, color <span class="op">=</span> <span class="st">"upper bound (pval)"</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">summary_shadar_har</span>, linewidth <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">observed</span> <span class="op">&gt;</span> <span class="va">pval_ub</span>, <span class="va">observed</span>, <span class="cn">NA</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"Alarm (pval)"</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">summary_shadar_har</span>, shape <span class="op">=</span> <span class="fl">3</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">observed</span> <span class="op">&gt;</span> <span class="va">posterior_ub</span>, <span class="va">observed</span>, <span class="cn">NA</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"Alarm (posterior)"</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">summary_shadar_har</span>, shape <span class="op">=</span> <span class="fl">4</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"black"</span>, <span class="st">"gold"</span>, <span class="st">"tomato"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"top"</span>, legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="excode_files/figure-html/unnamed-chunk-3-1.png" alt="**Figure 3:** Weekly *Salmonella Newport* cases with alarm thresholds (upper bounds)." width="576"><p class="caption">
<strong>Figure 3:</strong> Weekly <em>Salmonella Newport</em> cases with
alarm thresholds (upper bounds).
</p>
</div>
<p>Models ‘Mean’ and ‘FarringtonNoufaily’ can be applied likewise.</p>
</div>
<div class="section level2">
<h2 id="the-custom-model">The ‘Custom’ model<a class="anchor" aria-label="anchor" href="#the-custom-model"></a>
</h2>
<p>The ‘Custom’ model can be used to fit a model with covariate data
selected by the user. To give an example, data of <a href="https://robert-koch-institut.github.io/SARS-CoV-2-Infektionen_in_Deutschland/" class="external-link">SARS-CoV-2
infections in Berlin-Neukölln (Germany)</a> from March-July 2020 will be
used (downloaded on 2024-10-31). Figure 4 shows that after an inital
peak of infections in late March/early April, the number of infections
dropped, showing only few cases in May, followed by a rise in June which
could be attributed to several <a href="https://www.berlin.de/ba-neukoelln/aktuelles/pressemitteilungen/2020/pressemitteilung.950143.php" class="external-link">local
outbreaks</a>. The daily number of reported SARS-CoV-2 differs over the
course of a week, showing higher number of cases reported during
weekdays and lower number of cases during weekends. In the following a
‘Custom’ <code>excodeModel</code> is used, that models the mean number
of reported cases during the past 8 weeks on workdays and weekends, to
detect the observed local outbreaks.</p>
<p>To define the necessary covariate data for the model, a
<code>data.frame</code> - <code>weekday</code> - is created, indicating
whether a current day is a workday or weekend:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">sarscov2_df</span><span class="op">)</span></span>
<span><span class="va">num_wday</span> <span class="op">&lt;-</span> <span class="fu">wday</span><span class="op">(</span><span class="va">sarscov2_df</span><span class="op">$</span><span class="va">date</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">weekday</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>day <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">num_wday</span> <span class="op">&lt;=</span> <span class="fl">5</span>, <span class="st">"workday"</span>, <span class="st">"weekend"</span><span class="op">)</span>,</span>
<span>  levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"workday"</span>, <span class="st">"weekend"</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This is then used to create the ‘Custom’ <code>excodeModel</code>
object. Note that <code>timepoints_per_unit = 7</code> indicates that
the repeating time periods are weeks (by default this is 52, i.e. yearly
periodic data).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">excode_formula_custom</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/excodeFormula.html">excodeFormula</a></span><span class="op">(</span><span class="st">"Custom"</span>, data <span class="op">=</span> <span class="va">weekday</span>, timepoints_per_unit <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span>
<span><span class="va">excode_custom_pois</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/excodeModel.html">excodeModel</a></span><span class="op">(</span></span>
<span>  <span class="va">excode_family_pois</span>,</span>
<span>  <span class="va">excode_formula_custom</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>After this, the model is fitted, taking into account 8 weeks of
historic data (<code>time_units_back = 8</code>).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result_sarscov2_custom</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_excode.html">run_excode</a></span><span class="op">(</span><span class="va">sarscov2_df</span>,</span>
<span>  <span class="va">excode_custom_pois</span>,</span>
<span>  <span class="fl">93</span><span class="op">:</span><span class="fl">154</span>,</span>
<span>  time_units_back <span class="op">=</span> <span class="fl">8</span>,</span>
<span>  past_timepoints_not_incuded <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span><span class="va">summary_sarscov2_custom</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">result_sarscov2_custom</span><span class="op">)</span></span></code></pre></div>
<p>The results can be plotted as follows:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span></span>
<span>  <span class="va">sarscov2_df</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">summary_sarscov2_custom</span><span class="op">$</span><span class="va">date</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">observed</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_col</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"grey"</span>, fill <span class="op">=</span> <span class="st">"lightgrey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"No. of cases"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Day of reporting"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_date</span><span class="op">(</span>date_labels <span class="op">=</span> <span class="st">"%Y-%m"</span>, date_breaks <span class="op">=</span> <span class="st">"month"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_step</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">posterior_ub</span>, color <span class="op">=</span> <span class="st">"upper bound (posterior)"</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">summary_sarscov2_custom</span>, linewidth <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_step</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">pval_ub</span>, color <span class="op">=</span> <span class="st">"upper bound (pval)"</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">summary_sarscov2_custom</span>, linewidth <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">observed</span> <span class="op">&gt;</span> <span class="va">pval_ub</span>, <span class="va">observed</span>, <span class="cn">NA</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"Alarm (pval)"</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">summary_sarscov2_custom</span>, shape <span class="op">=</span> <span class="fl">3</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">observed</span> <span class="op">&gt;</span> <span class="va">posterior_ub</span>, <span class="va">observed</span>, <span class="cn">NA</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"Alarm (posterior)"</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">summary_sarscov2_custom</span>, shape <span class="op">=</span> <span class="fl">4</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"black"</span>, <span class="st">"gold"</span>, <span class="st">"tomato"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"top"</span>, legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="excode_files/figure-html/unnamed-chunk-7-1.png" alt="**Figure 4:** Daily reported SARS-CoV-2 infections in Berlin-Neukölln with alarm thresholds (upper bounds)." width="576"><p class="caption">
<strong>Figure 4:</strong> Daily reported SARS-CoV-2 infections in
Berlin-Neukölln with alarm thresholds (upper bounds).
</p>
</div>
</div>
<div class="section level2">
<h2 id="the-multistate-model">The ‘MultiState’ model<a class="anchor" aria-label="anchor" href="#the-multistate-model"></a>
</h2>
<p>The ‘MultiState’ model allows multiple states, which can be necessary
if the use of only one excess state is not sufficient to model the data.
This can be the case when the range of excess counts is very large. To
illustrate application of the ‘MultiState’ model, weekly all-cause
mortality data reported to the <a href="https://www.destatis.de/DE/Themen/Gesellschaft-Umwelt/Bevoelkerung/Sterbefaelle-Lebenserwartung/sterbefallzahlen.html" class="external-link">German
Federal Statistical Office</a> is used (Figure 5). The ‘MultiState’
model with four states is applied to detect weeks with excess mortality
in the time series.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"mort_df_germany"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">mort_df_germany</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">observed</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Number of deaths"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Week of death"</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="excode_files/figure-html/data%20mort_df_germany-1.png" alt="**Figure 5:** Weekly all-cause mortaility in Germany." width="576"><p class="caption">
<strong>Figure 5:</strong> Weekly all-cause mortaility in Germany.
</p>
</div>
<div class="section level3">
<h3 id="initialization-of-the-multistate-model">Initialization of the ‘MultiState’ model<a class="anchor" aria-label="anchor" href="#initialization-of-the-multistate-model"></a>
</h3>
<p>For models with only two states, <em>excode</em> automatically
initializes and fits the model. However, when using multiple states,
initialization of the GLM part of the model needs to be done manually.
In order to do so, initial estimates for the expected number of cases
for each state need to be provided. First the baseline number of deaths
is estimated, which roughly follows the <a href="https://www.euromomo.eu/graphs-and-maps" class="external-link">EuroMOMO</a> protocol.
The baseline fit uses sine and cosine functions to control for
seasonality as well as a linear time trend. To avoid overestimation of
the expected background mortality, only weeks 15 to 26 (spring) and 36
to 45 (autumn) are included to estimate the background model, since
these are time periods where no excess mortality is expected. All
necessary variables are stored in <code>mort_df_germany</code>:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">kable</span><span class="op">(</span><span class="fu">as_tibble</span><span class="op">(</span><span class="va">mort_df_germany</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">kable_styling</span><span class="op">(</span>font_size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span></span></code></pre></div>
<table class="table table" style="font-size: 11px; margin-left: auto; margin-right: auto;">
<thead><tr>
<th style="text-align:left;">
date
</th>
<th style="text-align:right;">
observed
</th>
<th style="text-align:left;">
id
</th>
<th style="text-align:right;">
timepoint
</th>
<th style="text-align:right;">
sin52
</th>
<th style="text-align:right;">
cos52
</th>
<th style="text-align:left;">
bckg_week
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
2016-01-03
</td>
<td style="text-align:right;">
17222
</td>
<td style="text-align:left;">
All cause mortality Germany
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
1.000
</td>
<td style="text-align:left;">
FALSE
</td>
</tr>
<tr>
<td style="text-align:left;">
2016-01-10
</td>
<td style="text-align:right;">
18469
</td>
<td style="text-align:left;">
All cause mortality Germany
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.121
</td>
<td style="text-align:right;">
0.993
</td>
<td style="text-align:left;">
FALSE
</td>
</tr>
<tr>
<td style="text-align:left;">
2016-01-17
</td>
<td style="text-align:right;">
18440
</td>
<td style="text-align:left;">
All cause mortality Germany
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0.239
</td>
<td style="text-align:right;">
0.971
</td>
<td style="text-align:left;">
FALSE
</td>
</tr>
<tr>
<td style="text-align:left;">
2016-01-24
</td>
<td style="text-align:right;">
18627
</td>
<td style="text-align:left;">
All cause mortality Germany
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
0.355
</td>
<td style="text-align:right;">
0.935
</td>
<td style="text-align:left;">
FALSE
</td>
</tr>
<tr>
<td style="text-align:left;">
2016-01-31
</td>
<td style="text-align:right;">
18707
</td>
<td style="text-align:left;">
All cause mortality Germany
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
0.465
</td>
<td style="text-align:right;">
0.885
</td>
<td style="text-align:left;">
FALSE
</td>
</tr>
<tr>
<td style="text-align:left;">
2016-02-07
</td>
<td style="text-align:right;">
18493
</td>
<td style="text-align:left;">
All cause mortality Germany
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
0.568
</td>
<td style="text-align:right;">
0.823
</td>
<td style="text-align:left;">
FALSE
</td>
</tr>
</tbody>
</table>
<p>Using a negative binomial model, the baseline mortality is estimated
as follows:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fit background model</span></span>
<span><span class="va">formula_bckg</span> <span class="op">&lt;-</span> <span class="st">"observed ~ sin52 + cos52 + timepoint"</span></span>
<span><span class="va">mort_glm_bckg</span> <span class="op">&lt;-</span> <span class="fu">glm.nb</span><span class="op">(</span><span class="va">formula_bckg</span>, <span class="va">mort_df_germany</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">bckg_week</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Extract prediction for baseline mortality</span></span>
<span><span class="va">mort_bckg_mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mort_glm_bckg</span>,</span>
<span>  newdata <span class="op">=</span> <span class="va">mort_df_germany</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"response"</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># store size parameter of ngeative binomial distribution</span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="va">mort_glm_bckg</span><span class="op">$</span><span class="va">theta</span></span></code></pre></div>
<p><em>excode</em> models the mean of the excess states as
multiplicative increase compared to the mean of the normal/background
state. Initial estimates for the mean of each excess state are chosen as
the 75%-, 85%-, and 95%-quantile of the relative increase of the
observed number of deaths compared to the estimated baseline, which
corresponds to a 6%, 10% and 21% increase:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Relative increase of observed mortality compared to background</span></span>
<span><span class="va">p_increase</span> <span class="op">&lt;-</span> <span class="va">mort_df_germany</span><span class="op">$</span><span class="va">observed</span> <span class="op">/</span> <span class="va">mort_bckg_mu</span></span>
<span></span>
<span><span class="co"># Initial values for multipicative increase of model states</span></span>
<span><span class="va">qcut</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.75</span>, <span class="fl">0.85</span>, <span class="fl">0.95</span><span class="op">)</span></span>
<span><span class="va">state_increase</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">p_increase</span>, prob <span class="op">=</span> <span class="va">qcut</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">state_increase</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mu0"</span>, <span class="st">"mu1"</span>, <span class="st">"mu2"</span>, <span class="st">"mu3"</span><span class="op">)</span></span>
<span><span class="va">state_increase</span></span></code></pre></div>
<pre><code><span><span class="co">##  mu0  mu1  mu2  mu3 </span></span>
<span><span class="co">## 1.00 1.06 1.10 1.21</span></span></code></pre>
<p>The initial estimates of the mean are calculated as follows:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Initial estimates of expected mortality of all states</span></span>
<span><span class="va">initial_mu</span> <span class="op">&lt;-</span> <span class="va">mort_bckg_mu</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">state_increase</span><span class="op">)</span></span>
<span><span class="fu">kable</span><span class="op">(</span><span class="fu">as_tibble</span><span class="op">(</span><span class="va">initial_mu</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">kable_styling</span><span class="op">(</span>font_size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span></span></code></pre></div>
<table class="table table" style="font-size: 11px; margin-left: auto; margin-right: auto;">
<thead><tr>
<th style="text-align:right;">
mu0
</th>
<th style="text-align:right;">
mu1
</th>
<th style="text-align:right;">
mu2
</th>
<th style="text-align:right;">
mu3
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
18059.8
</td>
<td style="text-align:right;">
19089.8
</td>
<td style="text-align:right;">
19881.9
</td>
<td style="text-align:right;">
21897.1
</td>
</tr>
<tr>
<td style="text-align:right;">
18162.4
</td>
<td style="text-align:right;">
19198.2
</td>
<td style="text-align:right;">
19994.9
</td>
<td style="text-align:right;">
22021.5
</td>
</tr>
<tr>
<td style="text-align:right;">
18244.6
</td>
<td style="text-align:right;">
19285.0
</td>
<td style="text-align:right;">
20085.3
</td>
<td style="text-align:right;">
22121.1
</td>
</tr>
<tr>
<td style="text-align:right;">
18304.8
</td>
<td style="text-align:right;">
19348.7
</td>
<td style="text-align:right;">
20151.6
</td>
<td style="text-align:right;">
22194.2
</td>
</tr>
<tr>
<td style="text-align:right;">
18342.2
</td>
<td style="text-align:right;">
19388.2
</td>
<td style="text-align:right;">
20192.8
</td>
<td style="text-align:right;">
22239.5
</td>
</tr>
<tr>
<td style="text-align:right;">
18356.1
</td>
<td style="text-align:right;">
19402.9
</td>
<td style="text-align:right;">
20208.0
</td>
<td style="text-align:right;">
22256.3
</td>
</tr>
</tbody>
</table>
<p>Now the model can be defined using <code><a href="../reference/excodeFormula.html">excodeFormula()</a></code>. In
this example, the estimated baseline (mu0) is kept fixed during model
fitting. To achieve this, it is included as offset
(<code>offset = TRUE</code>) in the estimation and the model is
estimated without intercept (<code>intercept = FALSE</code>):</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nStates</span> <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span><span class="va">excode_formula_multistate</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/excodeFormula.html">excodeFormula</a></span><span class="op">(</span><span class="st">"MultiState"</span>,</span>
<span>  nStates <span class="op">=</span> <span class="va">nStates</span>,</span>
<span>  intercept <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  offset <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="va">excode_family_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/excodeFamily.html">excodeFamily</a></span><span class="op">(</span><span class="st">"NegBinom"</span>, nb_size <span class="op">=</span> <span class="va">theta</span><span class="op">)</span></span>
<span><span class="va">excode_multistate_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/excodeModel.html">excodeModel</a></span><span class="op">(</span><span class="va">excode_family_nb</span>,</span>
<span>  <span class="va">excode_formula_multistate</span>,</span>
<span>  initial_mu <span class="op">=</span> <span class="va">initial_mu</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The last step before fitting the <em>excode</em> model is to define
the input <code>data.frame</code> containg all necessary variables. Note
that the offset variable is set to the estimated baseline mortality
(<code>mort_bckg_mu</code>) and timepoints where no excess is assumed
are included as 0s in the <code>state</code> variable (NA for other
weeks).</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create input data.frame</span></span>
<span><span class="va">mort_df_germany_input</span> <span class="op">&lt;-</span> <span class="va">mort_df_germany</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">bckg_week</span>, <span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>    offset <span class="op">=</span> <span class="va">mort_bckg_mu</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">observed</span>, <span class="va">offset</span>, <span class="va">id</span>, <span class="va">state</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="estimation-and-visualization-of-the-multistate-model">Estimation and visualization of the ‘MultiState’ model<a class="anchor" aria-label="anchor" href="#estimation-and-visualization-of-the-multistate-model"></a>
</h3>
<p>The ‘MultiState’ model can now be fitted using
<code><a href="../reference/run_excode.html">run_excode()</a></code> as usual:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_excode_multistate_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_excode.html">run_excode</a></span><span class="op">(</span><span class="va">mort_df_germany_input</span>,</span>
<span>  <span class="va">excode_multistate_nb</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">mort_df_germany_input</span><span class="op">)</span>,</span>
<span>  return_full_model <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  time_units_back <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="op">)</span></span>
<span><span class="va">res_mort_germany</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">res_excode_multistate_nb</span><span class="op">)</span></span></code></pre></div>
<p>The results and weekly excess probablities can be plottad as
follows:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">res_mort_germany</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span></span>
<span>  obs_excess <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">posterior0</span> <span class="op">&gt;</span> <span class="fl">0.5</span>, <span class="va">observed</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>  group <span class="op">=</span> <span class="st">"Data and model fit"</span></span>
<span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">observed</span>, color <span class="op">=</span> <span class="st">"Week with excess probabilty&lt;=0.5"</span><span class="op">)</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">mu0</span>, color <span class="op">=</span> <span class="st">"mu0 (normal)"</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">mu1</span>, color <span class="op">=</span> <span class="st">"mu1 (low excess)"</span><span class="op">)</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">0.75</span>, alpha <span class="op">=</span> <span class="fl">0.75</span>,</span>
<span>    linetype <span class="op">=</span> <span class="st">"dashed"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">mu2</span>, color <span class="op">=</span> <span class="st">"mu2 (medium excess)"</span><span class="op">)</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">0.75</span>, alpha <span class="op">=</span> <span class="fl">0.75</span>,</span>
<span>    linetype <span class="op">=</span> <span class="st">"dashed"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">mu3</span>, color <span class="op">=</span> <span class="st">"mu3 (high excess)"</span><span class="op">)</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">0.75</span>, alpha <span class="op">=</span> <span class="fl">0.75</span>,</span>
<span>    linetype <span class="op">=</span> <span class="st">"dashed"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">obs_excess</span>, color <span class="op">=</span> <span class="st">"Week with excess probabilty&gt;0.5"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">obs_excess</span>, color <span class="op">=</span> <span class="st">"Week with excess probabilty&gt;0.5"</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lightgreen"</span>, <span class="st">"gold"</span>, <span class="st">"orange"</span>, <span class="st">"tomato"</span>, <span class="st">"black"</span>, <span class="st">"cornflowerblue"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">group</span>, strip.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Number of deaths"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    axis.text.y <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, vjust <span class="op">=</span> <span class="fl">1</span>, hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>, legend.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>    legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>, legend.key.width <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">1</span>, <span class="st">"cm"</span><span class="op">)</span>,</span>
<span>    plot.margin <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="st">"cm"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">res_mort_germany</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span>excess_prob <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">posterior0</span>, group <span class="op">=</span> <span class="st">"Excess probability"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_ribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, ymin <span class="op">=</span> <span class="fl">0</span>, ymax <span class="op">=</span> <span class="va">excess_prob</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"cornflowerblue"</span>, fill <span class="op">=</span> <span class="st">"cornflowerblue"</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.75</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0.5</span>, linetype <span class="op">=</span> <span class="st">"dotted"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">group</span>, strip.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Week of death"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Excess probability"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>axis.text.y <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, vjust <span class="op">=</span> <span class="fl">1</span>, hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>plot.margin <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">layout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu">grid.arrange</span><span class="op">(</span>grobs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span>, layout_matrix <span class="op">=</span> <span class="va">layout</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="excode_files/figure-html/multistate%20plot-1.png" alt="**Figure 6:** *Top*: Weekly all-cause mortaility in Germany and expected mortality of the normal and three excess states are shown. Weeks with excess probabilty&gt;0.5 are shown in blue. *Bottom*: Weekly excess probability." width="672"><p class="caption">
<strong>Figure 6:</strong> <em>Top</em>: Weekly all-cause mortaility in
Germany and expected mortality of the normal and three excess states are
shown. Weeks with excess probabilty&gt;0.5 are shown in blue.
<em>Bottom</em>: Weekly excess probability.
</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="a-short-overview-of-the-statistical-model">A short overview of the statistical model<a class="anchor" aria-label="anchor" href="#a-short-overview-of-the-statistical-model"></a>
</h2>
<p>The <em>excode</em> package combines Generalized Linear Models (GLMs)
with Hidden Markov Models (HMMs). The GLM part of the model allows to
use regression models to model seasonal patterns and general trends in
the time series. Besides seasonal patterns and general time trends, an
algorithm for excess count detection needs to account for excess counts
in the historic data used for model estimation. The HMM part of the
statistical model used in <em>excode</em> allows to explicitly consider
past disease outbreaks in the model. The HMM separates the time series
in two (or more) states: the normal state and one (or multiple) excess
state. In the normal state, observed case counts lie within the range of
what is normally expected in a certain time period. In the excess state,
case counts are higher than what is normally expected, i.e. there is a
potential outbreak or excess mortality. This is in contrast most of
other algorithms used for excess count detection, which either do not
account for previous excess case counts or use some heuristic for down
weighting past instances of excess counts.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">har_model_pois</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_excode.html">run_excode</a></span><span class="op">(</span><span class="va">shadar_df</span>, <span class="va">excode_har_pois</span>, <span class="fl">285</span>,</span>
<span>  return_full_model <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">har_model_pois</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="excode_files/figure-html/Create%20model%20overview-1.png" alt="**Figure 7:** Components of an *excode* Harmonic model using a Poisson distribution." width="672"><p class="caption">
<strong>Figure 7:</strong> Components of an <em>excode</em> Harmonic
model using a Poisson distribution.
</p>
</div>
<p>The components of an example two state model are shown in Figure 7.
Each position <span class="math inline">\(t\)</span> in the time series
of length <span class="math inline">\(T\)</span> is in a state <span class="math inline">\(s_t \in \left\{ N,E\right\}, t\in
\left[1;T\right]\)</span> , where <span class="math inline">\(N\)</span>
represents the normal and <span class="math inline">\(E\)</span> the
excess state. The sequence of normal and excess states is modeled by the
HMM using initial state and transition probabilites (left boxes in
Figure 7):</p>
<ul>
<li>Initial state probabilities <span class="math inline">\(\Pr(s_{1}=N\bigr)\)</span> and <span class="math inline">\(\Pr(s_{1}=E\bigr)\)</span> give the probability
that the first time point of the time series is in the respective
state.</li>
<li>Transition probabilities give the probability that time point <span class="math inline">\(t\)</span> is in a specific state, given the state
of the previous time point. For instance, <span class="math inline">\(\Pr\left(s_{t}=N\left|s_{t-1}=N\right.\right)\)</span>,
<span class="math inline">\(t\in\left[1;T\right]\)</span> gives the
probability that the time series is in the normal state at time point
<span class="math inline">\(t\)</span>, given that position <span class="math inline">\(t-1\)</span> is also in the normal state. <span class="math inline">\(\Pr\left(s_{t}=E\left|s_{t-1}=N\right.\right)\)</span>
gives the probability to transition to the excess state at time point
<span class="math inline">\(t\)</span>, given that <span class="math inline">\(t-1\)</span> is in the normal state.</li>
</ul>
<p>In the example shown in Figure 7, the case counts <span class="math inline">\(c_{t}, t\in\left[1;T\right]\)</span> are assumed
to follow a Poisson distribution: <span class="math inline">\(c_{t} \sim
Pois \left(\mu_{t}\right)\)</span>. The expected case counts at position
<span class="math inline">\(t\)</span>, <span class="math inline">\(\mu_t\)</span> are modeled using a GLM using sine
and cosine functions to control for seasonal patterns (which is one of
the models available in <em>excode</em>):</p>
<p><span class="math display">\[
\log\mu_{t}=\beta_{0}+\beta_{1}t+ \beta_3 \cos(\frac{2\pi}{52}t) +
\beta_4\sin(\frac{2\pi}{52}t) +
\beta_{5}I\left(s_{t}=E\right)
\]</span></p>
<p>Here, <span class="math inline">\(\beta_{0}\)</span> is the
intercept, <span class="math inline">\(\beta_{1}t\)</span> a linear time
trend, <span class="math inline">\(\beta_3\)</span> and <span class="math inline">\(\beta_4\)</span> model the seasonal patterns using
<span class="math inline">\(\sin\)</span> and <span class="math inline">\(\cos\)</span> functions with weekly data (52 time
points per year). The increase in cases is incorporated by <span class="math inline">\(\beta_{5}\)</span>.</p>
<p>Based on this model, <em>excode</em> calculates a probability that
there is an excess of case counts at the current time point - the
posterior probability (bottom middle box in Figure 7). Moreover, given
the normally expected case counts in the model, a p-value for the null
hypothesis, that there is no excess at the current timepoint is
calculated (bottom right box in Figure 7).</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Benedikt Zacher.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
